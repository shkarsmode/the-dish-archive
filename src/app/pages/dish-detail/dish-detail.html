@if (isLoading()) {
    <div class="detail-loading">
        <div class="loading-spinner"></div>
    </div>
} @else if (!dish()) {
    <div class="detail-not-found">
        <span class="material-symbols-outlined not-found-icon">restaurant</span>
        <h2>Страву не знайдено</h2>
        <p>Можливо, вона була видалена або посилання невірне</p>
        <a routerLink="/" class="back-home-link">
            <span class="material-symbols-outlined">arrow_back</span>
            Повернутися до каталогу
        </a>
    </div>
} @else {
    <article class="dish-detail"
        (touchstart)="onTouchStart($event)"
        (touchend)="onTouchEnd($event)">
        <!-- Back Button -->
        <nav class="detail-nav">
            <a routerLink="/" class="back-button" aria-label="Назад до каталогу">
                <span class="material-symbols-outlined">arrow_back</span>
                <span class="back-label">Назад</span>
            </a>
            <div class="nav-actions">
                @if (adjacentDishes().prev) {
                    <a [routerLink]="['/dish', adjacentDishes().prev!.slug]" class="nav-arrow" aria-label="Попередній рецепт">
                        <span class="material-symbols-outlined">chevron_left</span>
                    </a>
                }
                @if (adjacentDishes().next) {
                    <a [routerLink]="['/dish', adjacentDishes().next!.slug]" class="nav-arrow" aria-label="Наступний рецепт">
                        <span class="material-symbols-outlined">chevron_right</span>
                    </a>
                }
                <app-favorites-button [dishId]="dish()!.id" />
                <button class="nav-action-btn share-btn" (click)="shareDish()" aria-label="Поділитися рецептом">
                    <span class="material-symbols-outlined">share</span>
                </button>
            </div>
        </nav>

        <!-- Hero Image -->
        <div class="detail-hero">
            <img
                [src]="currentImage"
                [alt]="currentImageAlt"
                class="hero-image"
                [style.viewTransitionName]="'dish-image-' + dish()!.id"
                (load)="onHeroLoad($event)"
                (error)="onImageError($event)" />

            <!-- Image Gallery Thumbnails -->
            @if (dish()!.images.length > 1) {
                <div class="gallery-thumbs">
                    @for (image of dish()!.images; track image.url; let i = $index) {
                        <button
                            class="gallery-thumb"
                            [class.active]="activeImageIndex() === i"
                            (click)="selectImage(i)"
                            [attr.aria-label]="'Фото ' + (i + 1)">
                            <img [src]="image.url" [alt]="image.alt" (error)="onImageError($event)" />
                        </button>
                    }
                </div>
            }
        </div>

        <div class="detail-content">
            <!-- Header -->
            <header class="detail-header">
                <div class="detail-categories">
                    @for (category of dish()!.categories; track category) {
                        <span class="category-label">{{ getCategoryLabel(category) }}</span>
                    }
                    @if (isNew()) {
                        <span class="new-badge">НОВЕ</span>
                    }
                </div>
                <h1 class="detail-title">{{ dish()!.title }}</h1>
                <p class="detail-description">{{ dish()!.description }}</p>
            </header>

            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stats-row stats-row--top">
                    <div class="stat">
                        <app-rating-stars [rating]="dish()!.rating" />
                    </div>
                    <div class="stat">
                        <span class="material-symbols-outlined stat-icon">schedule</span>
                        <span class="stat-value">{{ dish()!.cookingTime.total }}</span>
                        <span class="stat-label">хв</span>
                    </div>
                    <div class="stat">
                        <span class="material-symbols-outlined stat-icon">local_fire_department</span>
                        <span class="stat-value">{{ dish()!.calories }}</span>
                        <span class="stat-label">ккал</span>
                    </div>
                </div>
                <div class="stats-row stats-row--bottom">
                    <div class="stat">
                        <span class="material-symbols-outlined stat-icon">payments</span>
                        <span class="stat-value">{{ dish()!.price.amount }}</span>
                        <span class="stat-label">грн</span>
                    </div>
                    <div class="stat">
                        <span class="material-symbols-outlined stat-icon">group</span>
                        <span class="stat-value">{{ dish()!.servings }}</span>
                        <span class="stat-label">порц.</span>
                    </div>
                    <div class="stat">
                        <span class="material-symbols-outlined stat-icon">trending_up</span>
                        <span class="stat-value">{{ getDifficultyLabel(dish()!.difficulty) }}</span>
                    </div>
                </div>
            </div>

            <!-- Tags -->
            @if (dish()!.tags.length > 0) {
                <div class="detail-section tags-section">
                    <div class="tags-list">
                        @for (tag of dish()!.tags; track tag) {
                            <app-tag-chip [label]="tag" [clickable]="false" />
                        }
                    </div>
                </div>
            }

            <!-- Taste Profile -->
            @if (getTasteEntries(dish()!).length > 0) {
                <div class="detail-section">
                    <h2 class="section-title">Смаковий профіль</h2>
                    <app-taste-radar [tasteProfile]="dish()!.tasteProfile" />
                </div>
            }

            <!-- Ingredients -->
            <div class="detail-section">
                <h2 class="section-title">
                    <span class="material-symbols-outlined section-icon">grocery</span>
                    Інгредієнти
                    <span class="ingredient-count">{{ dish()!.ingredients.length }}</span>
                    @if (checklistService.checkedCount(dish()!.id, dish()!.ingredients.length)().count > 0) {
                        <button class="checklist-clear" (click)="checklistService.clearDish(dish()!.id)">
                            Скинути
                        </button>
                    }
                </h2>
                @if (checklistService.checkedCount(dish()!.id, dish()!.ingredients.length)().count > 0) {
                    <div class="checklist-progress">
                        <div class="checklist-progress-bar">
                            <div class="checklist-progress-fill"
                                 [style.width.%]="(checklistService.checkedCount(dish()!.id, dish()!.ingredients.length)().count / dish()!.ingredients.length) * 100">
                            </div>
                        </div>
                        <span class="checklist-progress-text">
                            {{ checklistService.checkedCount(dish()!.id, dish()!.ingredients.length)().count }}/{{ dish()!.ingredients.length }}
                        </span>
                    </div>
                }
                <ul class="ingredients-list">
                    @for (ingredient of dish()!.ingredients; track ingredient.name) {
                        <li class="ingredient"
                            [class.optional]="ingredient.optional"
                            [class.checked]="checklistService.isChecked(dish()!.id, ingredient.name)()"
                            (click)="toggleIngredient(dish()!.id, ingredient.name, dish()!.ingredients.length)">
                            <span class="ingredient-check">
                                <span class="material-symbols-outlined">
                                    {{ checklistService.isChecked(dish()!.id, ingredient.name)() ? 'check_circle' : 'radio_button_unchecked' }}
                                </span>
                            </span>
                            <span class="ingredient-name">
                                {{ ingredient.name }}
                                @if (ingredient.optional) {
                                    <span class="optional-badge">опціонально</span>
                                }
                            </span>
                            <span class="ingredient-dots"></span>
                            <span class="ingredient-amount">
                                {{ ingredient.amount }}{{ ingredient.unit ? ' ' + ingredient.unit : '' }}
                            </span>
                        </li>
                    }
                </ul>
            </div>

            <!-- Steps -->
            <div class="detail-section">
                <h2 class="section-title">
                    <span class="material-symbols-outlined section-icon">format_list_numbered</span>
                    Приготування
                </h2>
                <ol class="steps-list">
                    @for (step of dish()!.steps; track step.order) {
                        <li class="step"
                            [class.step-done]="isStepDone(step.order)"
                            (click)="toggleStep(step.order)">
                            <span class="step-number">
                                @if (isStepDone(step.order)) {
                                    <span class="material-symbols-outlined step-check">check</span>
                                } @else {
                                    {{ step.order }}
                                }
                            </span>
                            <div class="step-content">
                                <p class="step-text">{{ step.description }}</p>
                                @if (step.duration) {
                                    <span class="step-duration">
                                        <span class="material-symbols-outlined">schedule</span>
                                        {{ step.duration }} хв
                                    </span>
                                }
                            </div>
                        </li>
                    }
                </ol>
            </div>

            <!-- Notes -->
            @if (dish()!.notes) {
                <div class="detail-section">
                    <h2 class="section-title">
                        <span class="material-symbols-outlined section-icon">sticky_note_2</span>
                        Нотатки
                    </h2>
                    <div class="notes-card">
                        <p>{{ dish()!.notes }}</p>
                    </div>
                </div>
            }

            <!-- Source & Dates -->
            <footer class="detail-footer">
                @if (dish()!.sourceUrl) {
                    <a [href]="dish()!.sourceUrl" target="_blank" rel="noopener noreferrer" class="source-link">
                        <span class="material-symbols-outlined">open_in_new</span>
                        Джерело рецепта
                    </a>
                }
                <div class="detail-dates">
                    <span>Додано: {{ formatDate(dish()!.createdAt) }}</span>
                    @if (dish()!.updatedAt !== dish()!.createdAt) {
                        <span>Оновлено: {{ formatDate(dish()!.updatedAt) }}</span>
                    }
                </div>
            </footer>
        </div>
    </article>
}
